<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calm Minimal To-Do (Bootstrap + jQuery)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    :root{
      --bg: #f6f7f8;
      --card: #ffffff;
      --muted: #6b6f76;
      --accent: #7fbfff;
      --accent-2:#b8f1da;
    }
    [data-theme="dark"]{
      --bg:#0f1113;
      --card:#151718;
      --muted:#9aa0a6;
      --accent:#32a6ff;
      --accent-2:#3fd2a1;
      color-scheme: dark;
    }

    html,body { height:100%; background:var(--bg); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:18px; }
    .app { max-width:1100px; margin:0 auto; background:var(--card); border-radius:12px; box-shadow:0 8px 28px rgba(2,6,23,0.06); overflow:hidden; }
    .topbar { padding:14px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.04); }
    [data-theme="dark"] .topbar{ border-bottom-color: rgba(255,255,255,0.03); }

    .brand { display:flex; gap:12px; align-items:center; }
    .logo { width:46px; height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#032; background: linear-gradient(135deg,var(--accent),var(--accent-2)); }

    .sidebar { padding:18px; border-right:1px solid rgba(0,0,0,0.03); min-height:420px; }
    [data-theme="dark"] .sidebar{ border-right-color: rgba(255,255,255,0.03); }

    .category { padding:8px 10px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; color:var(--muted); margin-bottom:8px; }
    .category.active { background: linear-gradient(90deg, rgba(127,191,255,0.18), transparent); color:#051216; font-weight:600; }
    .task-row { display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:8px; margin-bottom:8px; transition:all .15s; border:1px solid rgba(0,0,0,0.03); background:transparent; }
    [data-theme="dark"] .task-row{ border-color: rgba(255,255,255,0.03); }
    .task-row.completed { opacity:0.65; text-decoration:line-through; }

    .priority-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-left:8px; }
    .p-high{ background:#ff6b6b; }
    .p-med { background:#ffc266; }
    .p-low { background:#9be7c4; }

    .muted { color:var(--muted); font-size:.9rem; }
    .tiny { font-size:.82rem; color:var(--muted); }

    .progress { height:10px; border-radius:999px; overflow:hidden; background: rgba(0,0,0,0.06); }
    [data-theme="dark"] .progress{ background: rgba(255,255,255,0.03); }

    /* responsive */
    @media (max-width:760px){
      .sidebar { display:flex; gap:8px; overflow-x:auto; padding:12px; border-right:0; border-bottom:1px solid rgba(0,0,0,0.04); }
      .main { padding:12px; }
    }
  </style>
</head>
<body data-theme="light">

<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">TD</div>
      <div>
        <div style="font-weight:700">Calm Tasks</div>
        <div class="tiny muted">Minimal productivity & event organization</div>
      </div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <input id="search" class="form-control form-control-sm" placeholder="Search tasks..." style="min-width:220px;">
      <select id="sort" class="form-select form-select-sm" style="width:160px;">
        <option value="new">Sort: Newest</option>
        <option value="due_asc">Due ↑</option>
        <option value="due_desc">Due ↓</option>
        <option value="priority">Priority</option>
      </select>
      <button id="themeToggle" class="btn btn-outline-secondary btn-sm">Dark</button>
    </div>
  </div>

  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar col-12 col-md-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div style="font-weight:700">Categories</div>
        <button id="addCategoryBtn" class="btn btn-sm btn-outline-primary">+ Add</button>
      </div>
      <div id="categoriesList"></div>

      <hr>
      <div class="tiny muted mb-2">Quick filters</div>
      <div class="form-check">
        <input id="showCompleted" class="form-check-input" type="checkbox">
        <label class="form-check-label tiny muted" for="showCompleted">Show completed</label>
      </div>
      <div class="form-check mt-1">
        <input id="reminderToggle" class="form-check-input" type="checkbox" checked>
        <label class="form-check-label tiny muted" for="reminderToggle">Enable reminders</label>
      </div>
    </div>

    <!-- Main -->
    <div class="col-12 col-md-9 p-3 main">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <div class="muted tiny">Today • <span id="todayCount">0</span> tasks</div>
          <div style="font-weight:700; font-size:1.15rem" id="selectedCategoryTitle">All Tasks</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button id="addTaskBtn" class="btn btn-primary">+ Add Task</button>
          <div style="width:220px;">
            <div class="progress" title="Completion">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2));"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form -->
      <div id="taskForm" style="display:none;" class="mb-3">
        <div class="card p-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-5">
              <input id="taskTitle" class="form-control" placeholder="Task title (required)">
            </div>
            <div class="col-md-3">
              <input id="taskDue" class="form-control" type="datetime-local">
            </div>
            <div class="col-md-2">
              <select id="taskPriority" class="form-select">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-2 text-end">
              <button id="saveTaskBtn" class="btn btn-success btn-sm">Save</button>
              <button id="cancelTaskBtn" class="btn btn-outline-secondary btn-sm">Cancel</button>
            </div>

            <div class="col-12 mt-2">
              <input id="taskCategory" class="form-control" placeholder="Category (optional)">
              <textarea id="taskDesc" class="form-control mt-2" rows="2" placeholder="Optional description"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks container -->
      <div id="tasksContainer"></div>

      <div class="tiny muted mt-2">Tip: click a task row to toggle complete. Use edit icon to modify details. Reminders show while page is open.</div>
    </div>
  </div>
</div>

<script>
  // jQuery-driven Minimal ToDo w/ localStorage
  $(function(){
    // Utilities
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    const saveKey = 'calm_todo_jq_v1';

    // Elements
    const $body = $('body');
    const $categoriesList = $('#categoriesList');
    const $tasksContainer = $('#tasksContainer');
    const $addTaskBtn = $('#addTaskBtn');
    const $taskForm = $('#taskForm');
    const $saveTaskBtn = $('#saveTaskBtn');
    const $cancelTaskBtn = $('#cancelTaskBtn');
    const $addCategoryBtn = $('#addCategoryBtn');
    const $selectedCategoryTitle = $('#selectedCategoryTitle');
    const $search = $('#search');
    const $sort = $('#sort');
    const $showCompleted = $('#showCompleted');
    const $progressBar = $('#progressBar');
    const $todayCount = $('#todayCount');
    const $themeToggle = $('#themeToggle');
    const $reminderToggle = $('#reminderToggle');

    // state
    let state = {
      categories: ['All','Work','Personal','Events','Shopping'],
      selectedCategory: 'All',
      tasks: [], // {id,title,desc,category,priority,dueISO,completed,createdAt,_reminded}
      editingId: null,
      settings: { theme:'light', reminders:true }
    };

    // load
    function load(){
      const raw = localStorage.getItem(saveKey);
      if (raw) {
        try { state = JSON.parse(raw); } catch(e){ console.warn('Bad saved state', e); }
      }
      applyTheme();
      renderCategories();
      renderTasks();
    }

    function save(){
      localStorage.setItem(saveKey, JSON.stringify(state));
    }

    // theme
    function applyTheme(){
      $body.attr('data-theme', state.settings.theme);
      $themeToggle.text(state.settings.theme === 'light' ? 'Dark' : 'Light');
    }
    $themeToggle.on('click', function(){ state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light'; applyTheme(); save(); });

    // categories
    function renderCategories(){
      $categoriesList.empty();
      state.categories.forEach(cat => {
        const count = cat === 'All' ? state.tasks.length : state.tasks.filter(t => t.category === cat).length;
        const $el = $(`<div class="category ${cat === state.selectedCategory ? 'active':''}"><span>${cat}</span><span class="muted tiny">${count}</span></div>`);
        $el.on('click', function(){ state.selectedCategory = cat; renderCategories(); renderTasks(); });
        $categoriesList.append($el);
      });
    }

    $addCategoryBtn.on('click', function(){
      const name = prompt('New category name:');
      if (!name) return;
      if (!state.categories.includes(name)) state.categories.push(name);
      renderCategories(); save();
    });

    // form open/close
    $addTaskBtn.on('click', function(){ openForm(null); });

    function openForm(task){
      $taskForm.show();
      $('#taskTitle').val(task ? task.title : '');
      $('#taskDesc').val(task ? task.desc : '');
      $('#taskPriority').val(task ? task.priority : 'medium');
      $('#taskDue').val(task && task.dueISO ? task.dueISO.slice(0,16) : '');
      $('#taskCategory').val(task ? (task.category === 'All' ? '' : task.category) : (state.selectedCategory === 'All' ? '' : state.selectedCategory));
      state.editingId = task ? task.id : null;
      $('#taskTitle').focus();
    }

    $cancelTaskBtn.on('click', function(){ $taskForm.hide(); state.editingId = null; });

    $saveTaskBtn.on('click', function(){
      const title = $('#taskTitle').val().trim();
      if (!title) { alert('Please enter a title'); return; }
      const desc = $('#taskDesc').val().trim();
      const priority = $('#taskPriority').val();
      const dueRaw = $('#taskDue').val();
      const dueISO = dueRaw ? new Date(dueRaw).toISOString() : null;
      const category = $('#taskCategory').val().trim() || 'All';

      if (state.editingId) {
        const t = state.tasks.find(x => x.id === state.editingId);
        if (t) Object.assign(t, { title, desc, priority, dueISO, category });
      } else {
        const newTask = { id: uid(), title, desc, priority, dueISO, category, completed:false, createdAt: new Date().toISOString() };
        state.tasks.unshift(newTask);
        if (!state.categories.includes(category) && category !== 'All') state.categories.push(category);
      }
      $taskForm.hide(); state.editingId = null;
      renderCategories(); renderTasks(); save();
    });

    // render tasks
    function renderTasks(){
      const q = $search.val().trim().toLowerCase();
      let tasks = state.tasks.slice();

      if (!$showCompleted.is(':checked')) tasks = tasks.filter(t => !t.completed);
      if (state.selectedCategory !== 'All') tasks = tasks.filter(t => t.category === state.selectedCategory);

      if (q) tasks = tasks.filter(t => (t.title + ' ' + (t.desc||'') + ' ' + (t.category||'')).toLowerCase().includes(q));

      const sort = $sort.val();
      if (sort === 'due_asc') tasks.sort((a,b) => (a.dueISO||'') > (b.dueISO||'') ? 1 : -1);
      else if (sort === 'due_desc') tasks.sort((a,b) => (a.dueISO||'') < (b.dueISO||'') ? 1 : -1);
      else if (sort === 'priority') {
        const map = { high:0, medium:1, low:2 };
        tasks.sort((a,b) => (map[a.priority] - map[b.priority]) || (new Date(b.createdAt) - new Date(a.createdAt)));
      } else {
        tasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      $tasksContainer.empty();
      if (!tasks.length) $tasksContainer.html('<div class="muted tiny">No tasks.</div>');

      tasks.forEach(task => {
        const $row = $(`
          <div class="task-row ${task.completed ? 'completed':''}" title="${escapeHtml(task.desc||'')}">
            <div style="display:flex; align-items:center; gap:12px; flex:1;">
              <input type="checkbox" class="form-check-input chk" ${task.completed ? 'checked':''} />
              <div>
                <div class="task-title" style="font-weight:600">${escapeHtml(task.title)}</div>
                <div class="tiny muted">${task.category === 'All' ? '' : escapeHtml(task.category)} ${task.dueISO ? ' • '+ formatDate(task.dueISO) : ''}</div>
              </div>
              <span class="priority-dot ${task.priority === 'high' ? 'p-high' : task.priority === 'medium' ? 'p-med' : 'p-low'}"></span>
            </div>
            <div class="controls">
              <button class="btn btn-sm btn-light btn-edit">✎</button>
              <button class="btn btn-sm btn-outline-danger btn-del">🗑️</button>
            </div>
          </div>
        `);

        // checkbox click
        $row.find('.chk').on('click', function(e){
          e.stopPropagation();
          task.completed = $(this).is(':checked');
          save(); renderTasks();
        });

        // row click toggles (if not clicked on button)
        $row.on('click', function(e){
          if ($(e.target).closest('.btn').length) return;
          task.completed = !task.completed; save(); renderTasks();
        });

        $row.find('.btn-edit').on('click', function(e){
          e.stopPropagation(); openForm(task);
        });

        $row.find('.btn-del').on('click', function(e){
          e.stopPropagation();
          if (confirm('Delete task?')) { state.tasks = state.tasks.filter(t => t.id !== task.id); save(); renderCategories(); renderTasks(); }
        });

        $tasksContainer.append($row);
      });

      // update progress and counts
      const total = state.tasks.length;
      const completed = state.tasks.filter(t => t.completed).length;
      $progressBar.css('width', total ? Math.round(completed/total*100) + '%' : '0%');
      $todayCount.text(tasks.length);
      $selectedCategoryTitle.text(state.selectedCategory === 'All' ? 'All Tasks' : state.selectedCategory);
    }

    // helpers
    function formatDate(iso){
      if (!iso) return '';
      const d = new Date(iso);
      const opts = { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
      return d.toLocaleString(undefined, opts);
    }
    function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // search/sort handlers
    $search.on('input', renderTasks);
    $sort.on('change', renderTasks);
    $showCompleted.on('change', renderTasks);

    // keyboard N -> new task
    $(document).on('keydown', function(e){
      if (e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); openForm(null); }
    });

    // reminders: check every 30s for near-due tasks (while page open)
    function checkReminders(){
      if (!$reminderToggle.is(':checked')) return;
      const now = new Date();
      state.tasks.forEach(t => {
        if (!t.dueISO || t._reminded || t.completed) return;
        const due = new Date(t.dueISO);
        // if due within next 60s or already passed
        if (due <= new Date(now.getTime() + 60000)) {
          showNotification(`Due: ${t.title}`, t.desc || formatDate(t.dueISO));
          t._reminded = true;
          save();
        }
      });
    }

    function showNotification(title, body){
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        new Notification(title, { body, silent:true });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(p => { if (p === 'granted') new Notification(title, { body, silent:true }); });
      }
    }

    setInterval(checkReminders, 30000);

    // highlight overdue tasks every 15s (sets _overdue flag and re-render)
    setInterval(()=> {
      const now = Date.now();
      state.tasks.forEach(t => {
        if (!t.dueISO || t._overdue || t.completed) return;
        if (new Date(t.dueISO).getTime() <= now) { t._overdue = true; save(); renderTasks(); }
      });
    }, 15000);

    // persist across tabs
    $(window).on('storage', function(e){
      if (e.originalEvent.key === saveKey) load();
    });

    // seed demo tasks if empty
    function seedIfEmpty(){
      if (state.tasks && state.tasks.length) return;
      const nowISO = new Date().toISOString();
      state.tasks = [
        { id: uid(), title: 'Submit project statement', desc: 'Finalize & upload to LMS', category:'Work', priority:'high', dueISO: null, completed:false, createdAt:nowISO },
        { id: uid(), title: 'Create UI wireframe', desc: 'Minimal cards & calm colors', category:'Work', priority:'medium', dueISO: null, completed:false, createdAt:nowISO },
        { id: uid(), title: 'Buy groceries', desc:'Milk, eggs, salad', category:'Shopping', priority:'low', dueISO: null, completed:false, createdAt:nowISO }
      ];
      save();
    }

    // init
    seedIfEmpty();
    load();

    // save when leaving
    $(window).on('beforeunload', save);
  });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
